<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>3D FIre Spread Simulator</title>
  <meta name="viewport" content="width=device-width" />
  <style>
    html, body, #app { margin:0; height:100%; background:#111; overflow:hidden; }
    #hud {
      position: fixed;
      left: 10px;
      top: 10px;
      background: rgba(0,0,0,0.6);
      color: #eee;
      font: 14px/1.4 system-ui;
      padding: 8px 12px;
      border-radius: 8px;
      max-height: 90%;
      overflow-y: auto;
    }
     .hud { position:fixed; left:10px; top:10px; color:#eee; font:14px/1.4 system-ui; }
    .hud input[type=range]{ width:280px; }
    .panel { background:rgba(0,0,0,.45); padding:8px 10px; border-radius:10px; }
    .row { margin:6px 0; }
  </style>
  <!-- ✅ vtk.js UMD bundle -->
  <script src="./src/js/vtk.js@28.3.1.js"></script>
  <!-- PapaParse (CSV parser) -->
  <script src="./src/js/papaparse@.js"></script>
   <script src="./src/js/volume_rendering.js"></script>
   <script src="./src/js/scene_control.js"></script>
   <script src="./src/js/wind_map_vis.js"></script>
   <script src="./src/js/obj_loader.js"></script>
    <script src="./src/js/user_control.js"></script> 
</head>
<body>
  <div id="app">
  

  </div>
  <div class="hud panel">
    <div class="row">
      Views:
      <button id="vx">+X</button>
      <button id="vxn">−X</button>
      <button id="vy">+Y</button>
      <button id="vyn">−Y</button>
      <button id="vz">+Z</button>
      <button id="vzn">−Z</button>
      <button id="proj">Orthographic</button>
    </div>


     <div class="row">
      Time:
      <input id="timeSlider" type="range" min="1" max="0" value="0" step="1">
      <span id="tl">1</span>
      <button id="play">▶</button>
    </div>
        <!-- 
    <div class="row">
      Ignition:
      <select id="ign_loc"></select>
    </div>
    <div class="row">
      Wind dir:
      <select id="wind_dir"></select>
    </div>
    <div class="row">
      Wind speed:
      <select id="wind_spd"></select>
    </div>
-->
  </div>
   

  <script> 
    // === Path to your OBJ ===

    

    //const ignp2 = ["236_116_30","80_103_57","60_327_41","54_344_37"];
    // "[[236,116,30]]" "[[38,118,35]]" "[[73,164,138]]" "[[80,103,57]]" "[[60,327,41]]" "[[274, 254, 40]]" "[[298, 240, 33]]" "[[235, 204, 34]]" "[[54,344,37]]" "[[60,327,41]]"

    //const ignp2 = ["107_23_37","139_69_33","155_25_25","277_190_33", "187_259_61", "205_284_37", "100_164_31", "84_207_38"];
    const ignp2 = ["236_116_30","38_118_35", "73_164_138", "80_103_57", "60_327_41", "274_254_40", "298_240_33", "235_204_34", "54_344_37", "60_327_41"];
    const ignp3 = ["84_207_38","100_164_31", "187_259_61", "205_284_37",];
  
    const simScenarios3 = [
      "wd0.0_sp0.0_n50_c10.0_gs120.0_sd6",  //0
      "wd0.0_sp5.0_n50_c10.0_gs120.0_sd6",   //1
      "wd0.0_sp10.0_n50_c10.0_gs120.0_sd6",   //2
      "wd0.0_sp15.0_n50_c10.0_gs120.0_sd6",    //3
 
      
      "wd45.0_sp5.0_n50_c10.0_gs120.0_sd6",    //4
      "wd45.0_sp10.0_n50_c10.0_gs120.0_sd6",   //5
      "wd45.0_sp15.0_n50_c10.0_gs120.0_sd6",    //6
      "wd45.0_sp20.0_n50_c10.0_gs120.0_sd6",    //7

      "wd225.0_sp5.0_n50_c10.0_gs120.0_sd6",    //8
      "wd135.0_sp5.0_n50_c10.0_gs120.0_sd6",    //9
      "wd135.0_sp15.0_n50_c10.0_gs120.0_sd6",    //10

      "wd90.0_sp15.0_n50_c10.0_gs120.0_sd6",    //11
      "wd225.0_sp15.0_n50_c10.0_gs120.0_sd6",    //12
    

      "wd135.0_sp5.0_n5000_c10.0_gs120.0_sd6", /*turbulend demonstartion*/
      "wd225.0_sp5.0_n3000_c10.0_gs120.0_sd6"  /*turbulend demonstartion2*/     
    ]

    const dire = "270.0";
    const windspd = "5.0";
  

    //const CSVUrl = './ani/voxel_fire_spread_15_313_56_df_sub_shell2_255088-0-1000_0-1000_0-1000_c_3.csv';
    const scenario_selection = ignp2[0]+"/"+simScenarios3[14];
    const hb = "hb1600"
    const CSVUrl = './outputs/scenarios/'+scenario_selection+"/voxel_fire_spread_"+hb+".csv";
    const WindUrl = './outputs/scenarios/'+scenario_selection+"/wind_field.png";
    
    
    const fullScreenRenderer = vtk.Rendering.Misc.vtkFullScreenRenderWindow.newInstance({
                  rootContainer: document.getElementById('app'),
                  background: [0.1, 0.1, 0.1],
                });

    const renderer = fullScreenRenderer.getRenderer();
    const renderWindow = fullScreenRenderer.getRenderWindow();

    

    load_obj(renderer);
    load_simulation (CSVUrl);






    function load_simulation (csvUrl){
            
          // Load a CSV and group data by timestep
              async function loadCSVasFrames(csvUrl) {
              return new Promise((resolve, reject) => {
                Papa.parse(csvUrl, {
                  download: true,
                  header: true,
                  dynamicTyping: true,
                  skipEmptyLines: true,
                  complete: (results) => {
                    if (results.errors.length) {
                      console.warn("CSV parse warnings:", results.errors);
                    }
                    const frameData = {};
                    results.data.forEach(row => {
                      const t = row.timestep;
                      const id = row.voxel_id;
                      const state = row.new_state;
                      if (t == null || id == null || state == null) return; // skip bad rows
                      if (!frameData[t]) frameData[t] = [];
                      frameData[t].push({ id, state });
                    });
                    resolve(frameData);
                  }
                });
              });
            }

            // 2) set many at once from pairs like [ ['V_0_300_53', [1,0,0]], ... ]
            function colorObjectsFromPairs(pairs, actorMap, renderWindow) {
              for (const [id, rgb] of pairs) {
                const actor = actorMap[id];
                if (!actor) {
                  console.warn(`No actor for id: ${id}`);
                  continue;
                }
                actor.getProperty().setColor(rgb[0], rgb[1], rgb[2]);
              }
              renderWindow.render();
            }

            let framesg = {}; // declare once
            const stateToColor = (s) => ({
              0:[0.4,0.4,0.4],
              1:[0.12,0.47,0.71],
              2:[1.00,0.50,0.05],
              3:[0.84,0.16,0.16],
              4:[0.17,0.63,0.17],
            }[s] || [1,1,1]);

            

          const updateVolume = makeSafeVolumeUpdater(renderer, renderWindow);

          var global_pairs = [];
          var pre_f = 0;
            
            (async () => {
              framesg = await loadCSVasFrames(CSVUrl);
              //console.log("Frames loaded:", framesg);
              //console.log("Frame 0 data:", framesg[0]);

              // Now connect AFTER frames are loaded
              connectFramesUI(framesg, (t, frame) => {
                //console.log("At timestep", t, "frame has", frame.length, "rows");
                const ids = framesg[t].map(item => [item.id, item.state]);
                const pairs = ids.map(s => ["V_" + s[0].replace(/-/g, "_"), s[1]]);
                if (t>pre_f){
                  pre_f = t;
                }else{
                  global_pairs = []
                  pre_f = t;
                }
                global_pairs =  upsertPairsInPlace(global_pairs, pairs); 
                updateVolume(global_pairs);
              });
            })();




            // Wire up buttons
          document.getElementById('vx') .addEventListener('click', () => snapView('x', +1, true));
          document.getElementById('vxn').addEventListener('click', () => snapView('x', -1, true));
          document.getElementById('vy') .addEventListener('click', () => snapView('y', +1, true));
          document.getElementById('vyn').addEventListener('click', () => snapView('y', -1, true));
          document.getElementById('vz') .addEventListener('click', () => snapView('z', +1, true));
          document.getElementById('vzn').addEventListener('click', () => snapView('z', -1, true));

          // Toggle orthographic/perspective for the *current* view
          document.getElementById('proj').addEventListener('click', () => {
              const cam = renderer.getActiveCamera();
              const nowParallel = !cam.getParallelProjection();
              cam.setParallelProjection(nowParallel);
              document.getElementById('proj').textContent = nowParallel ? 'Orthographic' : 'Perspective';
              // Re-snap to keep framing tidy
              const { center } = getSceneCenterAndRadius(renderer);
              cam.setFocalPoint(...center);
              renderer.resetCameraClippingRange();
              renderWindow.render();
          });

    } // load_simulation


    


  </script>
</body>
</html>
